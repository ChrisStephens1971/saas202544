name: Bootstrap Validation Check

on:
  pull_request:
    branches: [master, main]
  push:
    branches: [master, main]
  workflow_dispatch:

jobs:
  boot-check:
    name: Validate Bootstrap Configuration
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for template system remnants
        id: check-template-system
        run: |
          if [ -d ".template-system" ]; then
            echo "❌ FAIL: .template-system/ directory still exists in repository"
            echo "This directory should not be committed to project repositories"
            echo "Please remove it: rm -rf .template-system"
            exit 1
          else
            echo "✅ PASS: .template-system/ not found (expected)"
          fi

      - name: Check for unreplaced placeholders
        id: check-placeholders
        run: |
          # Search for {{PLACEHOLDER}} patterns in config files
          PLACEHOLDERS=$(grep -r "{{" \
            --include="*.md" \
            --include="*.json" \
            --include="*.jsonc" \
            --include="*.yml" \
            --include="*.yaml" \
            --include="*.tf" \
            --include="*.tfvars" \
            --include="*.bicep" \
            --exclude-dir=".git" \
            --exclude-dir="node_modules" \
            --exclude-dir=".terraform" \
            --exclude="*.lock*" \
            . 2>/dev/null | grep -v "github\.com\|actions\|secrets\|vars\|PLACEHOLDER" || true)

          if [ -n "$PLACEHOLDERS" ]; then
            echo "❌ FAIL: Found unreplaced placeholders:"
            echo "$PLACEHOLDERS"
            exit 1
          else
            echo "✅ PASS: No unreplaced placeholders found"
          fi

      - name: Validate Azure naming convention
        id: check-naming
        run: |
          # Check that resource names follow pattern: {prefix}-{org}-{proj}-{env}-{region}-{seq}
          # Example: rg-verdaio-saas202544-dev-eastus2-01

          if [ -f "template.vars.json" ]; then
            ORG=$(jq -r '.org' template.vars.json)
            PROJ=$(jq -r '.proj' template.vars.json)
            PATTERN=$(jq -r '.naming.pattern' template.vars.json)

            echo "✅ PASS: Found template.vars.json"
            echo "  org=$ORG"
            echo "  proj=$PROJ"
            echo "  naming pattern=$PATTERN"

            # Validate pattern matches expected format
            if [[ ! "$PATTERN" =~ \{prefix\}.*\{org\}.*\{proj\}.*\{env\} ]]; then
              echo "❌ FAIL: Naming pattern doesn't match expected format"
              exit 1
            fi
          else
            echo "⚠️ WARNING: template.vars.json not found"
          fi

      - name: Check required environment files
        id: check-env-files
        run: |
          MISSING_FILES=()

          # Check for environment-specific configuration
          for ENV in dev stg prd; do
            if [ ! -f "environments/${ENV}.tfvars" ]; then
              MISSING_FILES+=("environments/${ENV}.tfvars")
            fi
            if [ ! -f "environments/${ENV}.parameters.jsonc" ]; then
              MISSING_FILES+=("environments/${ENV}.parameters.jsonc")
            fi
          done

          if [ ${#MISSING_FILES[@]} -gt 0 ]; then
            echo "❌ FAIL: Missing required environment files:"
            printf '%s\n' "${MISSING_FILES[@]}"
            exit 1
          else
            echo "✅ PASS: All environment files present (dev/stg/prd)"
          fi

      - name: Validate JSON/JSONC syntax
        id: check-json
        run: |
          INVALID_FILES=()

          # Find and validate all JSON/JSONC files (excluding node_modules, .terraform)
          while IFS= read -r file; do
            # Strip comments for JSONC files
            if [[ "$file" == *.jsonc ]]; then
              if ! jq -e . "$file" >/dev/null 2>&1; then
                # Try stripping comments and validating
                if ! grep -v '^\s*//' "$file" | jq -e . >/dev/null 2>&1; then
                  INVALID_FILES+=("$file")
                fi
              fi
            else
              if ! jq -e . "$file" >/dev/null 2>&1; then
                INVALID_FILES+=("$file")
              fi
            fi
          done < <(find . -type f \( -name "*.json" -o -name "*.jsonc" \) \
            -not -path "*/node_modules/*" \
            -not -path "*/.terraform/*" \
            -not -path "*/build/*" \
            -not -path "*/dist/*")

          if [ ${#INVALID_FILES[@]} -gt 0 ]; then
            echo "❌ FAIL: Invalid JSON/JSONC syntax in:"
            printf '%s\n' "${INVALID_FILES[@]}"
            exit 1
          else
            echo "✅ PASS: All JSON/JSONC files are valid"
          fi

      - name: Check for secrets in repository
        id: check-secrets
        run: |
          # Check for common secret patterns (basic check, gitleaks runs separately)
          SECRETS_FOUND=false

          # Check for Azure client secrets
          if grep -r "client_secret\|clientSecret" \
            --include="*.tf" \
            --include="*.yml" \
            --include="*.yaml" \
            --include="*.json" \
            --exclude-dir=".git" \
            . 2>/dev/null | grep -v "use_oidc\|client-id\|CLIENT_ID"; then
            echo "❌ WARNING: Found potential client_secret references"
            SECRETS_FOUND=true
          fi

          # Check for hardcoded subscription IDs in workflows (should use vars)
          if grep -r "subscription.*:.*[0-9a-f]{8}-[0-9a-f]{4}" \
            .github/workflows/ 2>/dev/null | grep -v "vars\.AZURE"; then
            echo "❌ WARNING: Found hardcoded subscription IDs in workflows"
            echo "Use \${{ vars.AZURE_SUBSCRIPTION_ID }} instead"
            SECRETS_FOUND=true
          fi

          if [ "$SECRETS_FOUND" = false ]; then
            echo "✅ PASS: No obvious secrets detected (full scan with gitleaks recommended)"
          else
            echo "⚠️ WARNING: Potential secrets detected - review findings above"
            # Don't fail the check, just warn
          fi

      - name: Validate Terraform backend configuration
        id: check-tf-backend
        run: |
          if [ -f "infrastructure/terraform/backend.tf" ]; then
            # Check for use_azuread_auth instead of access_key
            if grep -q "use_azuread_auth.*=.*true" infrastructure/terraform/backend.tf; then
              echo "✅ PASS: Terraform backend uses Azure AD auth (no access keys)"
            elif grep -q "use_oidc.*=.*true" infrastructure/terraform/backend.tf; then
              echo "✅ PASS: Terraform backend uses OIDC auth"
            else
              echo "❌ FAIL: Terraform backend not configured for Azure AD/OIDC auth"
              echo "Expected: use_azuread_auth = true OR use_oidc = true"
              exit 1
            fi

            # Check for required backend config
            if ! grep -q "resource_group_name" infrastructure/terraform/backend.tf || \
               ! grep -q "storage_account_name" infrastructure/terraform/backend.tf || \
               ! grep -q "container_name" infrastructure/terraform/backend.tf; then
              echo "❌ FAIL: Terraform backend missing required configuration"
              exit 1
            fi

            echo "✅ PASS: Terraform backend properly configured"
          else
            echo "⚠️ WARNING: infrastructure/terraform/backend.tf not found"
          fi

      - name: Summary
        if: always()
        run: |
          echo "## Bootstrap Validation Summary"
          echo ""
          echo "| Check | Status |"
          echo "|-------|--------|"
          echo "| Template system remnants | ${{ steps.check-template-system.outcome }} |"
          echo "| Unreplaced placeholders | ${{ steps.check-placeholders.outcome }} |"
          echo "| Azure naming convention | ${{ steps.check-naming.outcome }} |"
          echo "| Required environment files | ${{ steps.check-env-files.outcome }} |"
          echo "| JSON/JSONC syntax | ${{ steps.check-json.outcome }} |"
          echo "| Secrets check | ${{ steps.check-secrets.outcome }} |"
          echo "| Terraform backend config | ${{ steps.check-tf-backend.outcome }} |"
